<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>translate.service - admin</title>

  <link rel="stylesheet" href="./src/css/layui.css">
  <style>
    body {padding: 32px; /*overflow-y: scroll;*/}
    .translate-result-language-text-item{
      float:left;
      text-align:left;
      display: initial;
    }
    .layui-table-cell{
      overflow: inherit;
    }
  </style>
</head>
<body>

<!-- 搜索表单 -->
<div class="layui-form" style="padding-bottom: 20px;">
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">翻译文本</label>
      <div class="layui-input-inline">
        <input type="text" id="originalText" name="originalText" required lay-verify="required" placeholder="请输入翻译文本" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">目标域名</label>
      <div class="layui-input-inline">
        <input type="text" id="domain" name="domain" placeholder="请输入目标域名" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">翻译语种</label>
      <div class="layui-input-inline">
        <input type="text" id="to" name="to" placeholder="请输入翻译语种" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <a class="layui-btn" href="javascript:;" onclick="searchTranslation();" style="margin-left: 15px;">搜索</a>
    </div>
  </div>
</div>

<script type="text/html" id="translate-result-td">
  <ul>
    {{#  layui.each(d.translateResult, function(index, item){ }}
    <li class="translate-result-language-text-item">
      <b>{{ item.language }}</b>  : {{ item.text }}
      <button class="layui-btn layui-btn-xs" onclick="editTranslateText('{{ d.id }}', '{{ item.language }}', '{{ item.text }}', '{{ item.domain }}', '{{ item.originalText }}')">
        <i class="layui-icon layui-icon-edit"></i>
      </button>
    </li>
    {{#  }); }}
  </ul>
</script>
<table class="layui-hide" id="ID-table-demo-data"></table>
<script src="./src/layui.js"></script>
<script src="./translate.service.js"></script>
<script>

  var table;
  layui.use(['form', 'table', 'layer', 'jquery'], function(){
    var form = layui.form;
    var table = layui.table;
    var layer = layui.layer;
    var $ = layui.jquery; // 使用 Layui 自带的 jQuery

    // 搜索功能
    window.searchTranslation = function () {
      var originalText = $('#originalText').val().trim();
      var domainInput = $('#domain').val().trim();
      var to = $('#to').val().trim();

      // 校验翻译文本是否为空
      if (!originalText) {
        layer.msg('翻译文本不能为空', { icon: 2 });
        return;
      }

      var params = {
        token: token,
        originalText: originalText
      };
      if (domainInput) params.domain = domainInput;
      if (to) params.to = to;

      // 发送请求
      request.post(domain + 'admin/cache/getCacheTextList.json', params, function (result) {
        console.log(result);

        // 初始化表格数据
        let tableData = [];

        // 检查接口返回结果
        if (result.result === 0 && result.info) {
          layer.msg(result.info, { icon: 2 }); // 显示错误提示
          // 继续渲染空表格
        } else if (result.list && result.list.length > 0) {
          // 正常数据处理逻辑
          for (var i = 0; i < result.list.length; i++) {
            for (var key in result.list[i]) {
              if (key.indexOf('to_') === 0 && result.list[i][key].length > 0) {
                console.log(key);
                if (typeof (result.list[i]['translateResult']) === 'undefined') {
                  result.list[i]['translateResult'] = [];
                }
                result.list[i]['translateResult'].push({ 'language': key.replace('to_', ''), 'text': result.list[i][key] ,'domain': result.list[i]['domain'],'originalText': result.list[i]['text']});
              }
            }
            // 将 addtime 的时间戳转为 2025-12-12 23:23:23 格式
            result.list[i]['addtime'] = timestampToTime(result.list[i]['addtime']);
          }
          tableData = result.list; // 使用处理后的数据
        }

        // 渲染表格
        table.render({
          elem: '#ID-table-demo-data',
          cols: [[
            { field: 'text', title: '翻译前的原文本', width: 300, sort: true },
            { field: 'domain', title: '域名/key', width: 120 },
            { field: 'addtime', title: '初次翻译时间', minWidth: 160 },
            { field: 'translateResult', title: '翻译结果', width: 300, templet: '#translate-result-td' }
          ]],
          data: tableData,
          skin: 'line',
          page: true,
          limit: 200,
          done: function (res, curr, count) {
            console.log('Rendered table data:', res.data);
            if (count === 0) {
              layer.msg('暂无数据', { icon: 7 });
            }
          }
        });
      });
    };

    // 初始加载表格
    searchTranslation();
  });

  /*
    编辑某条翻译的结果
    id 列表中某个tr行的hash
    language 编辑的是哪个语言的译文，传入如  english
    text 编辑的译文内容
    domain 域名
    originalText 原文
  */
  function editTranslateText(id, language, text, domain,originalText) {

    // 弹出 iframe 窗口
    layer.open({
      type: 2,
      title: '编辑翻译 【' + language +'】',
      area: ['90%', '90%'],
      shadeClose: true,
      content: './edit-translate-text.html?originalText=' + encodeURIComponent(originalText) +
              '&language=' + encodeURIComponent(language) +
              '&text=' + encodeURIComponent(text) +
              '&domain=' + encodeURIComponent(domain) +
              '&originalText=' + encodeURIComponent(originalText)
    });
  }

  function timestampToTime(timestamp) {
    // 时间戳为10位需*1000，时间戳为13位不需乘1000
    var date = new Date(timestamp * 1000);
    var Y = date.getFullYear() + "-";
    var M = (date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1) + "-";
    var D = (date.getDate() < 10 ? "0" + date.getDate() : date.getDate()) + " ";
    var h = (date.getHours() < 10 ? "0" + date.getHours() : date.getHours()) + ":";
    var m = (date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes()) + ":";
    var s = (date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds());
    return Y + M + D + h + m + s;
  }
</script>
</body>
</html>